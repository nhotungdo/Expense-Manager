<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Money Tracking</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/MoneyTracker.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    @await RenderSectionAsync("Styles", required: false)
</head>

<body>
    @RenderBody()

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Check authentication on page load
        $(document).ready(function () {
            checkAuthentication();
        });

        function checkAuthentication() {
            // Don't redirect if we're on HomePage or Login page
            const currentPath = window.location.pathname;
            if (currentPath === '/HomePage' || currentPath === '/Login') {
                return;
            }

            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/Login';
                return;
            }

            // Load user info
            loadUserInfo();
        }

        async function loadUserInfo() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userName').textContent = user.fullName || user.username;
                    if (user.pictureUrl) {
                        document.getElementById('userAvatar').src = user.pictureUrl;
                    }

                    // Show admin section if user is admin
                    if (user.role === 'ADMIN') {
                        document.getElementById('adminSection').style.display = 'block';
                    }

                    // Store user info in localStorage for other pages
                    localStorage.setItem('user', JSON.stringify(user));
                } else if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    window.location.href = '/Login';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                });
            } catch (error) {
                console.error('Error during logout:', error);
            } finally {
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                window.location.href = '/Login';
            }
        }

        // Toggle sidebar
        $("#sidebarToggle, #sidebarToggleTop").on('click', function (e) {
            $("body").toggleClass("sidebar-toggled");
            $(".sidebar").toggleClass("toggled");
            if ($(".sidebar").hasClass("toggled")) {
                $('.sidebar .collapse').collapse('hide');
            }
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>

</html>